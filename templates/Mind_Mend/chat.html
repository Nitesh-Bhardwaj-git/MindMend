{% extends 'base.html' %}
{% block title %}AI Chat{% endblock %}
{% block content %}
<style>
    /* Page-local chat styles to avoid stale static cache issues */
    #chatMessages {
        display: flex;
        flex-direction: column;
        gap: 12px;
    }
    #chatMessages .chat-row {
        display: flex;
        flex-direction: column;
        max-width: 85%;
        width: fit-content;
    }
    #chatMessages .chat-row-user {
        align-self: flex-end;
        align-items: flex-end;
    }
    #chatMessages .chat-row-bot {
        align-self: flex-start;
        align-items: flex-start;
    }
    #chatMessages .chat-sender {
        font-size: 12px;
        line-height: 1;
        font-weight: 600;
        color: #6b7280;
        margin-bottom: 4px;
    }
    #chatMessages .chat-bubble {
        background: #ffffff;
        color: #111827;
        border: 1px solid #d1d5db;
        border-radius: 14px;
        box-shadow: 0 1px 2px rgba(17, 24, 39, 0.08);
        padding: 10px 14px;
        white-space: pre-wrap;
        word-break: break-word;
    }
    #chatMessages .chat-row-user .chat-bubble {
        background: #d9f99d;
        border-color: #bef264;
        color: #1f2937;
        border-bottom-right-radius: 4px;
    }
    #chatMessages .chat-row-bot .chat-bubble {
        background: #ffffff;
        border-color: #d1d5db;
        color: #111827;
        border-bottom-left-radius: 4px;
    }
    #chatMessages .chat-time {
        display: block;
        margin-top: 6px;
        font-size: 10px;
        line-height: 1;
        opacity: 0.75;
    }
    #chatMessages .chat-row-user .chat-time { text-align: right; }
    #chatMessages .chat-row-bot .chat-time { text-align: left; }

    #chatMessages .chat-typing {
        align-self: flex-start;
        align-items: flex-start;
    }
    #chatMessages .chat-typing .chat-bubble {
        padding: 12px 14px;
        min-width: 56px;
    }
    #chatMessages .chat-typing-dots {
        display: flex;
        align-items: center;
        gap: 6px;
    }
    #chatMessages .chat-typing-dots span {
        width: 6px;
        height: 6px;
        border-radius: 999px;
        background: #374151;
        animation: mmTypingBounce 1.3s ease-in-out infinite;
    }
    #chatMessages .chat-typing-dots span:nth-child(2) { animation-delay: 0.18s; }
    #chatMessages .chat-typing-dots span:nth-child(3) { animation-delay: 0.36s; }
    @keyframes mmTypingBounce {
        0%, 80%, 100% { transform: scale(0.65); opacity: 0.45; }
        40% { transform: scale(1); opacity: 1; }
    }
</style>
<div class="max-w-4xl mx-auto px-4 sm:px-6 lg:px-8 py-6">
    <div class="flex flex-col sm:flex-row justify-between items-start sm:items-center gap-4 mb-6">
        <div>
            <h2 class="text-2xl font-semibold mb-1">Chat</h2>
            <p class="text-gray-600">Talk to someone who listens. Share what's on your mind—English & Hindi.</p>
        </div>
        <div class="flex rounded-lg border border-primary overflow-hidden">
            <label class="flex cursor-pointer">
                <input type="radio" class="peer sr-only" name="lang" id="langEn" value="en" checked>
                <span class="px-4 py-2 peer-checked:bg-primary peer-checked:text-white bg-white text-gray-700">English</span>
            </label>
            <label class="flex cursor-pointer border-l border-gray-200">
                <input type="radio" class="peer sr-only" name="lang" id="langHi" value="hi">
                <span class="px-4 py-2 peer-checked:bg-primary peer-checked:text-white bg-white text-gray-700">Hindi</span>
            </label>
        </div>
    </div>
    <div class="bg-white rounded-2xl shadow-lg overflow-hidden max-w-2xl mx-auto">
        <div class="h-[28rem] overflow-y-auto p-4 bg-gray-50" id="chatMessages">
            <div class="chat-row chat-row-bot" id="welcomeMsg">
                <div class="chat-sender">MindMend</div>
                <div class="chat-bubble">
                    Hey! Good to see you. How are you doing today? Whatever you're feeling—good, not so good, or just okay—I'm here to listen. Tell me what's on your mind.
                    <span class="chat-time" id="welcomeTime"></span>
                </div>
            </div>
        </div>
        <div class="p-4 border-t">
            <form id="chatForm" class="flex gap-2 items-center">
                <input type="text" id="messageInput" class="flex-1 px-4 py-3 border border-gray-300 rounded-lg focus:ring-2 focus:ring-primary focus:border-primary outline-none" placeholder="Type your message..." autocomplete="off">
                <button type="button" id="micBtn" class="p-3 rounded-lg border border-gray-300 hover:bg-gray-100 transition" title="Voice input (speak instead of type)">
                    <svg class="w-6 h-6 text-gray-600" fill="currentColor" viewBox="0 0 24 24"><path d="M12 14c1.66 0 3-1.34 3-3V5c0-1.66-1.34-3-3-3S9 3.34 9 5v6c0 1.66 1.34 3 3 3zm5.91-3c-.49 0-.9.36-.98.85C16.52 14.2 14.47 16 12 16s-4.52-1.8-4.93-4.15c-.08-.49-.49-.85-.98-.85-.61 0-1.09.54-1 1.14.49 3 2.89 5.35 5.91 5.78V20c0 .55.45 1 1 1s1-.45 1-1v-2.08c3.02-.43 5.42-2.78 5.91-5.78.1-.6-.39-1.14-1-1.14z"/></svg>
                </button>
                <button type="submit" class="px-6 py-3 bg-primary text-white rounded-lg font-medium hover:bg-primary-dark transition">Send</button>
            </form>
            <p id="micStatus" class="text-sm text-gray-500 mt-1 hidden">Listening... speak now.</p>
        </div>
    </div>
    <div id="recommendations" class="mt-4 max-w-2xl mx-auto"></div>
</div>
{% endblock %}
{% block scripts %}
<script>
(function() {
    const form = document.getElementById('chatForm');
    const input = document.getElementById('messageInput');
    const messages = document.getElementById('chatMessages');
    const recs = document.getElementById('recommendations');
    const welcomeMsg = document.getElementById('welcomeMsg');
    const langEn = document.getElementById('langEn');
    const langHi = document.getElementById('langHi');
    let sessionId = localStorage.getItem('mindmend_session') || '';

    function getLang() { return langHi.checked ? 'hi' : 'en'; }
    function getTimeString() {
        var d = new Date();
        var h = d.getHours(), m = d.getMinutes();
        var am = h < 12;
        h = h % 12 || 12;
        return h + ':' + (m < 10 ? '0' : '') + m + (am ? ' am' : ' pm');
    }
    const welcomeEn = "Hey! Good to see you. How are you doing today? Whatever you're feeling—good, not so good, or just okay—I'm here to listen. Tell me what's on your mind.";
    const welcomeHi = "नमस्ते! अच्छा लगा कि आप आए। आज कैसे हैं? जो भी महसूस कर रहे हों—अच्छा, अच्छा नहीं, या बस ठीक—मैं सुनने के लिए यहां हूं। बताइए क्या चल रहा है।";
    function updatePlaceholder() {
        input.placeholder = getLang() === 'hi' ? 'अपना संदेश लिखें...' : 'Type your message...';
        if (welcomeMsg && messages.querySelectorAll('.chat-row').length <= 1) {
            var bubble = welcomeMsg.querySelector('.chat-bubble');
            if (bubble) bubble.innerHTML = (getLang() === 'hi' ? welcomeHi : welcomeEn) + '<span class="chat-time">' + getTimeString() + '</span>';
        }
    }
    langEn.addEventListener('change', updatePlaceholder);
    langHi.addEventListener('change', updatePlaceholder);

    function addMsg(text, isUser) {
        var row = document.createElement('div');
        row.className = 'chat-row ' + (isUser ? 'chat-row-user' : 'chat-row-bot');
        var sender = document.createElement('div');
        sender.className = 'chat-sender';
        sender.textContent = isUser ? 'You' : 'MindMend';
        var bubble = document.createElement('div');
        bubble.className = 'chat-bubble';
        bubble.textContent = text;
        var time = document.createElement('span');
        time.className = 'chat-time';
        time.textContent = getTimeString();
        bubble.appendChild(time);
        row.appendChild(sender);
        row.appendChild(bubble);
        messages.appendChild(row);
        messages.scrollTop = messages.scrollHeight;
    }
    function addBotMsgWithTyping(text) {
        return new Promise(function(resolve) {
            var row = document.createElement('div');
            row.className = 'chat-row chat-row-bot';

            var sender = document.createElement('div');
            sender.className = 'chat-sender';
            sender.textContent = 'MindMend';

            var bubble = document.createElement('div');
            bubble.className = 'chat-bubble';

            var content = document.createElement('span');
            var time = document.createElement('span');
            time.className = 'chat-time';

            bubble.appendChild(content);
            bubble.appendChild(time);
            row.appendChild(sender);
            row.appendChild(bubble);
            messages.appendChild(row);
            messages.scrollTop = messages.scrollHeight;

            var fullText = text || '';
            var index = 0;
            var step = Math.max(1, Math.ceil(fullText.length / 70));
            var timer = setInterval(function() {
                index = Math.min(fullText.length, index + step);
                content.textContent = fullText.slice(0, index);
                messages.scrollTop = messages.scrollHeight;
                if (index >= fullText.length) {
                    clearInterval(timer);
                    time.textContent = getTimeString();
                    resolve();
                }
            }, 18);
        });
    }

    function showTyping() {
        var row = document.createElement('div');
        row.className = 'chat-row chat-typing';
        row.id = 'typingIndicator';
        row.innerHTML = '<div class="chat-sender">MindMend</div><div class="chat-bubble"><div class="chat-typing-dots"><span></span><span></span><span></span></div></div>';
        messages.appendChild(row);
        messages.scrollTop = messages.scrollHeight;
    }
    function hideTyping() {
        var el = document.getElementById('typingIndicator');
        if (el) el.remove();
    }

    (function setWelcomeTime() {
        var t = document.getElementById('welcomeTime');
        if (t) t.textContent = getTimeString();
    })();

    // Load prior conversation for logged-in users
    const priorMessages = {{ prior_messages_json|safe }};
    if (priorMessages && priorMessages.length > 0) {
        welcomeMsg.style.display = 'none';
        priorMessages.forEach(function(m) {
            addMsg(m.content, m.role === 'user');
        });
    }

    function showRecommendations(items) {
        recs.innerHTML = '';
        if (!items || items.length === 0) return;
        items.forEach(r => {
            const card = document.createElement('div');
            card.className = 'recommendation-card' + (r.priority === 'urgent' ? ' urgent' : '');
            card.innerHTML = '<strong>' + r.title + '</strong><p class="mb-0 mt-1">' + r.content + '</p>';
            recs.appendChild(card);
        });
    }

    // Voice input
    const micBtn = document.getElementById('micBtn');
    const micStatus = document.getElementById('micStatus');
    const SpeechRecognition = window.SpeechRecognition || window.webkitSpeechRecognition;
    let recognition = null;
    let isListening = false;

    if (SpeechRecognition) {
        recognition = new SpeechRecognition();
        recognition.continuous = false;
        recognition.interimResults = true;
        recognition.lang = getLang() === 'hi' ? 'hi-IN' : 'en-IN';

        recognition.onresult = function(e) {
            const transcript = Array.from(e.results).map(r => r[0].transcript).join('').trim();
            if (transcript) input.value = transcript;
        };
        recognition.onend = function() {
            isListening = false;
            micBtn.classList.remove('bg-red-100', 'border-red-400');
            micStatus.classList.add('hidden');
        };
        recognition.onerror = function() {
            isListening = false;
            micBtn.classList.remove('bg-red-100', 'border-red-400');
            micStatus.classList.add('hidden');
        };

        micBtn.addEventListener('click', function() {
            if (isListening) {
                recognition.stop();
                return;
            }
            input.focus();
            recognition.lang = getLang() === 'hi' ? 'hi-IN' : 'en-IN';
            recognition.start();
            isListening = true;
            micBtn.classList.add('bg-red-100', 'border-red-400');
            micStatus.classList.remove('hidden');
            micStatus.textContent = 'Listening... speak now.';
        });
    } else {
        micBtn.style.display = 'none';
    }

    form.addEventListener('submit', async (e) => {
        e.preventDefault();
        var msg = input.value.trim();
        if (!msg) return;
        addMsg(msg, true);
        input.value = '';
        var btn = form.querySelector('button[type="submit"]');
        if (btn) btn.disabled = true;
        showTyping();

        try {
            var res = await fetch('{% url "chat_api" %}', {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ message: msg, session_id: sessionId, lang: getLang() })
            });
            var data = await res.json();
            if (data.session_id) {
                sessionId = data.session_id;
                localStorage.setItem('mindmend_session', sessionId);
            }
            hideTyping();
            await addBotMsgWithTyping(data.response || 'Sorry, something went wrong.');
            showRecommendations(data.recommendations || []);
        } catch (err) {
            hideTyping();
            await addBotMsgWithTyping('Unable to connect. Please try again.');
        }
        if (btn) btn.disabled = false;
    });
})();
</script>
{% endblock %}
