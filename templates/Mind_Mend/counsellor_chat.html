{% extends 'base.html' %}
{% block title %}Chat with Counsellor{% endblock %}
{% block content %}
<div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex flex-col sm:flex-row sm:items-center sm:justify-between gap-2 mb-4">
        <h2 class="text-2xl font-semibold">Live Chat</h2>
        {% if request.user.id == booking.counsellor.user_id %}
        <a href="{% url 'doctor_dashboard' %}" class="text-primary font-medium hover:underline">← Doctor Dashboard</a>
        {% else %}
        <a href="{% url 'my_bookings' %}" class="text-primary font-medium hover:underline">← My Bookings</a>
        {% endif %}
    </div>
    <p class="text-gray-600 mb-4">
        <strong>{{ booking.counsellor.name }}</strong> — {{ booking.date|date:"l, M d, Y" }} at {{ booking.time_slot|time:"H:i" }}
    </p>
    {% if booking.status == 'completed' %}
    <div class="mb-4 inline-flex items-center px-3 py-1 rounded-full bg-gray-100 text-gray-800 text-sm font-medium">Session Completed</div>
    {% endif %}
    {% if booking.status != 'completed' and booking.status != 'cancelled' %}
    <div class="mb-4">
        <form method="post" action="{% url 'finish_session' booking.id %}" onsubmit="return confirm('Finish this session now? This will disable chat and mark it as completed.');">
            {% csrf_token %}
            <input type="hidden" name="next" value="{% url 'counsellor_chat' booking.id %}">
            <button type="submit" class="px-4 py-2 rounded-lg bg-gray-100 text-gray-800 hover:bg-gray-700 hover:text-white transition font-medium">Finish Session</button>
        </form>
    </div>
    {% endif %}

    <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden flex flex-col" style="min-height: 400px;">
        <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3" style="max-height: 360px;">
            {% for m in chat_messages %}
            <div class="flex {% if m.sender_id == request.user.id %}justify-end{% else %}justify-start{% endif %}" data-message-id="{{ m.id }}">
                <div class="max-w-full sm:max-w-[85%] rounded-2xl px-4 py-2 {% if m.sender_id == request.user.id %}bg-primary text-white{% else %}bg-gray-100 text-gray-900{% endif %}">
                    <p class="text-xs opacity-80 mb-0.5">
                        {{ m.sender.get_username }}
                        {% if m.sender_id == booking.counsellor.user_id %} (Counsellor){% else %} (Patient){% endif %}
                    </p>
                    <p class="whitespace-pre-wrap break-words">{{ m.content }}</p>
                    <p class="text-xs opacity-70 mt-1">{{ m.created_at|date:"M d, H:i" }}</p>
                </div>
            </div>
            {% empty %}
            <p class="text-gray-500 text-center py-8" id="emptyChatState">No messages yet. Say hello to start the conversation.</p>
            {% endfor %}
        </div>

        {% if booking.status == 'completed' or booking.status == 'cancelled' %}
        <div class="p-4 border-t border-gray-200 bg-gray-50 text-sm text-gray-600">Chat is disabled because this session is {{ booking.status }}.</div>
        {% else %}
        <form method="post" class="p-4 border-t border-gray-200 flex flex-col sm:flex-row gap-2" id="chatForm">
            {% csrf_token %}
            <input type="text" name="content" id="chatInput" placeholder="Type a message..." class="flex-1 rounded-xl border border-gray-300 px-4 py-2 focus:ring-2 focus:ring-primary focus:border-primary" autocomplete="off">
            <button type="submit" class="px-4 py-2 bg-primary text-white rounded-xl hover:bg-primary-dark transition font-medium sm:w-auto w-full">Send</button>
        </form>
        {% endif %}
    </div>

    <p class="text-sm text-gray-500 mt-2">Messages are delivered in real time.</p>
</div>

<script>
(function() {
    var chatEl = document.getElementById('chatMessages');
    var chatInput = document.getElementById('chatInput');
    var chatForm = document.getElementById('chatForm');
    var csrfInput = chatForm ? chatForm.querySelector('input[name="csrfmiddlewaretoken"]') : null;
    var csrfToken = csrfInput ? csrfInput.value : '';
    var apiUrl = "{% url 'booking_messages_api' booking.id %}";
    var bookingId = {{ booking.id }};
    var myUserId = {{ request.user.id }};
    var counsellorUserId = {% if booking.counsellor.user_id %}{{ booking.counsellor.user_id }}{% else %}null{% endif %};
    var protocol = window.location.protocol === 'https:' ? 'wss://' : 'ws://';
    var socket = null;
    var latestMessageId = 0;
    var knownMessageIds = {};
    var pollingTimer = null;
    var pollInFlight = false;

    if (chatEl) {
        Array.prototype.forEach.call(chatEl.querySelectorAll('[data-message-id]'), function(node) {
            var id = Number(node.getAttribute('data-message-id') || 0);
            if (id > 0) {
                knownMessageIds[id] = true;
                if (id > latestMessageId) latestMessageId = id;
            }
        });
    }

    function escapeHtml(value) {
        return String(value || '').replace(/</g, '&lt;').replace(/>/g, '&gt;');
    }

    function removeEmptyState() {
        var empty = document.getElementById('emptyChatState');
        if (empty) empty.remove();
    }

    function appendMessage(m) {
        var msgId = Number(m.id || 0);
        if (msgId && knownMessageIds[msgId]) return;
        if (msgId) {
            knownMessageIds[msgId] = true;
            if (msgId > latestMessageId) latestMessageId = msgId;
        }
        var isMe = m.sender_id === myUserId;
        var role = m.sender_id === counsellorUserId ? ' (Counsellor)' : ' (Patient)';
        var div = document.createElement('div');
        div.className = 'flex ' + (isMe ? 'justify-end' : 'justify-start');
        if (msgId) div.setAttribute('data-message-id', String(msgId));
        div.innerHTML = '<div class="max-w-full sm:max-w-[85%] rounded-2xl px-4 py-2 ' + (isMe ? 'bg-primary text-white' : 'bg-gray-100 text-gray-900') + '">' +
            '<p class="text-xs opacity-80 mb-0.5">' + escapeHtml(m.sender) + role + '</p>' +
            '<p class="whitespace-pre-wrap break-words">' + escapeHtml(m.content) + '</p>' +
            '<p class="text-xs opacity-70 mt-1">' + new Date(m.created_at).toLocaleString() + '</p></div>';
        removeEmptyState();
        chatEl.appendChild(div);
        chatEl.scrollTop = chatEl.scrollHeight;
    }

    function startSocket() {
        socket = new WebSocket(protocol + window.location.host + '/ws/booking/' + bookingId + '/chat/');
        socket.onmessage = function(event) {
            try {
                var data = JSON.parse(event.data);
                if (data.type === 'chat_message' && data.message) {
                    appendMessage(data.message);
                } else if (data.type === 'chat_locked') {
                    alert(data.message || 'Session is completed. Chat disabled.');
                }
            } catch (err) {}
        };
        socket.onclose = function() {
            setTimeout(startSocket, 3000);
        };
        socket.onerror = function() {};
    }

    async function sendViaHttp(content) {
        var res = await fetch(apiUrl, {
            method: 'POST',
            headers: {
                'Content-Type': 'application/json',
                'X-CSRFToken': csrfToken
            },
            body: JSON.stringify({ content: content })
        });
        if (!res.ok) return;
        var data = await res.json();
        if (data && data.message) appendMessage(data.message);
    }

    async function pollMessages() {
        if (pollInFlight) return;
        pollInFlight = true;
        try {
            var url = apiUrl + '?after_id=' + encodeURIComponent(String(latestMessageId || 0));
            var res = await fetch(url, { credentials: 'same-origin' });
            if (!res.ok) return;
            var data = await res.json();
            var list = (data && data.messages) ? data.messages : [];
            list.forEach(appendMessage);
        } catch (err) {
        } finally {
            pollInFlight = false;
        }
    }

    startSocket();
    pollMessages();
    pollingTimer = setInterval(pollMessages, 2000);

    if (chatForm) {
        chatForm.addEventListener('submit', function(e) {
            e.preventDefault();
            var content = (chatInput.value || '').trim();
            if (!content) return;
            if (socket && socket.readyState === WebSocket.OPEN) {
                socket.send(JSON.stringify({ content: content }));
            } else {
                sendViaHttp(content);
            }
            chatInput.value = '';
        });
    }
})();
</script>
{% endblock %}
