{% extends 'base.html' %}
{% block title %}Chat with Counsellor{% endblock %}
{% block content %}
<div class="max-w-3xl mx-auto px-4 sm:px-6 lg:px-8 py-8">
    <div class="flex items-center justify-between mb-4">
        <h2 class="text-2xl font-semibold">Live Chat</h2>
        <a href="{% url 'my_bookings' %}" class="text-primary font-medium hover:underline">← My Bookings</a>
    </div>
    <p class="text-gray-600 mb-4">
        <strong>{{ booking.counsellor.name }}</strong> — {{ booking.date|date:"l, M d, Y" }} at {{ booking.time_slot|time:"H:i" }}
    </p>

    <div class="bg-white rounded-2xl shadow-lg border border-gray-200 overflow-hidden flex flex-col" style="min-height: 400px;">
        <div id="chatMessages" class="flex-1 overflow-y-auto p-4 space-y-3" style="max-height: 360px;">
            {% for m in chat_messages %}
            <div class="flex {% if m.sender_id == request.user.id %}justify-end{% else %}justify-start{% endif %}">
                <div class="max-w-[85%] rounded-2xl px-4 py-2 {% if m.sender_id == request.user.id %}bg-primary text-white{% else %}bg-gray-100 text-gray-900{% endif %}">
                    <p class="text-xs opacity-80 mb-0.5">{{ m.sender.get_username }}{% if m.sender_id != request.user.id %} (Counsellor){% endif %}</p>
                    <p class="whitespace-pre-wrap break-words">{{ m.content }}</p>
                    <p class="text-xs opacity-70 mt-1">{{ m.created_at|date:"M d, H:i" }}</p>
                </div>
            </div>
            {% empty %}
            <p class="text-gray-500 text-center py-8">No messages yet. Say hello to start the conversation.</p>
            {% endfor %}
        </div>

        <form method="post" class="p-4 border-t border-gray-200 flex gap-2">
            {% csrf_token %}
            <input type="text" name="content" id="chatInput" placeholder="Type a message..." class="flex-1 rounded-xl border border-gray-300 px-4 py-2 focus:ring-2 focus:ring-primary focus:border-primary" autocomplete="off">
            <button type="submit" class="px-4 py-2 bg-primary text-white rounded-xl hover:bg-primary-dark transition font-medium">Send</button>
        </form>
    </div>

    <p class="text-sm text-gray-500 mt-2">Messages refresh when you send. Refresh the page to see new messages from your counsellor.</p>
</div>

<script>
(function() {
    // Optional: poll for new messages every 8 seconds when tab is visible
    var lastId = {% if chat_messages %}{{ chat_messages.last.id }}{% else %}0{% endif %};
    var chatEl = document.getElementById('chatMessages');
    function poll() {
        if (document.hidden || !chatEl) return;
        fetch('{% url "booking_messages_api" booking.id %}?since=' + (new Date(Date.now() - 15000).toISOString()))
            .then(function(r) { return r.json(); })
            .then(function(data) {
                (data.messages || []).forEach(function(m) {
                    if (m.id <= lastId) return;
                    lastId = Math.max(lastId, m.id);
                    var isMe = m.sender === '{{ request.user.username|escapejs }}';
                    var div = document.createElement('div');
                    div.className = 'flex ' + (isMe ? 'justify-end' : 'justify-start');
                    div.innerHTML = '<div class="max-w-[85%] rounded-2xl px-4 py-2 ' + (isMe ? 'bg-primary text-white' : 'bg-gray-100 text-gray-900') + '">' +
                        '<p class="text-xs opacity-80 mb-0.5">' + m.sender + (isMe ? '' : ' (Counsellor)') + '</p>' +
                        '<p class="whitespace-pre-wrap break-words">' + (m.content || '').replace(/</g, '&lt;').replace(/>/g, '&gt;') + '</p>' +
                        '<p class="text-xs opacity-70 mt-1">' + m.created_at + '</p></div>';
                    chatEl.appendChild(div);
                    chatEl.scrollTop = chatEl.scrollHeight;
                });
            })
            .catch(function() {});
    }
    setInterval(poll, 8000);
})();
</script>
{% endblock %}
