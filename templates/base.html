{% load static %}
<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{% block title %}MindMend{% endblock %} | AI-Enabled Health Awareness & Support</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script>
        tailwind.config = {
            theme: {
                extend: {
                    colors: {
                        primary: { DEFAULT: '#2d6a4f', light: '#40916c', dark: '#1b4332' },
                        accent: '#95d5b2'
                    },
                    fontFamily: {
                        sans: ['DM Sans', 'system-ui', 'sans-serif'],
                        display: ['Playfair Display', 'serif']
                    }
                }
            }
        }
    </script>
    <link href="https://fonts.googleapis.com/css2?family=DM+Sans:wght@400;500;600;700&family=Playfair+Display:wght@500;600&display=swap" rel="stylesheet">
    <link rel="stylesheet" href="{% static 'css/style.css' %}">
</head>
<body class="min-h-screen flex flex-col bg-gray-50 text-gray-900 pt-[70px] font-sans">
    <nav class="fixed top-0 left-0 right-0 z-[9999] bg-gradient-to-r from-primary-dark to-primary shadow-lg">
        <div class="w-full px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <a href="{% url 'home' %}" class="flex items-center flex-shrink-0 gap-3 -ml-4 sm:-ml-6 lg:-ml-8 pl-2 sm:pl-4">
                    <img src="{% static 'images/mindmend-logo.png' %}" alt="MindMend" class="h-10 sm:h-12 object-contain">
                    <span class="text-xl sm:text-2xl font-semibold text-black">MindMend</span>
                </a>
                <button type="button" class="md:hidden p-2 rounded-lg text-white hover:bg-white/10" id="navToggle" aria-label="Toggle menu">
                    <svg class="w-6 h-6" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M4 6h16M4 12h16M4 18h16"/></svg>
                </button>
                <div class="hidden md:flex items-center gap-6" id="navbarMenu">
                    <a href="{% url 'home' %}" class="text-white/90 hover:text-white font-medium transition">Home</a>
                    <a href="{% url 'chat' %}" class="text-white/90 hover:text-white font-medium transition">AI Chat</a>
                    <a href="{% url 'assessments' %}" class="text-white/90 hover:text-white font-medium transition">Assessments</a>
                    <a href="{% url 'counsellor_booking' %}" class="text-white/90 hover:text-white font-medium transition">Book Counsellor</a>
                    <a href="{% url 'mood_tracker' %}" class="text-white/90 hover:text-white font-medium transition">Mood</a>
                    <a href="{% url 'contact_us' %}" class="text-white/90 hover:text-white font-medium transition">Contact</a>
                    {% if user.is_authenticated %}
                        <div class="relative group" id="dashboardDropdown">
                            <button type="button" class="flex items-center gap-1 text-white/90 hover:text-white font-medium transition cursor-pointer" id="dashboardDropdownBtn" aria-haspopup="true" aria-expanded="false">
                                Dashboard
                                <svg class="w-4 h-4" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"/></svg>
                            </button>
                            <div class="absolute right-0 mt-1 w-48 py-2 bg-white rounded-lg shadow-xl border border-gray-100 opacity-0 invisible group-hover:opacity-100 group-hover:visible transition-all duration-150 z-[9999]" id="dashboardDropdownMenu">
                                <a href="{% url 'dashboard' %}" class="block px-4 py-2 text-gray-700 hover:bg-primary/10 hover:text-primary">Dashboard</a>
                                <a href="{% url 'doctor_dashboard' %}" class="block px-4 py-2 text-gray-700 hover:bg-primary/10 hover:text-primary">Doctor Panel</a>
                                <a href="{% url 'resources' %}" class="block px-4 py-2 text-gray-700 hover:bg-primary/10 hover:text-primary">Helplines</a>
                                <a href="{% url 'forum_list' %}" class="block px-4 py-2 text-gray-700 hover:bg-primary/10 hover:text-primary">Support Forum</a>
                                <a href="{% url 'location_map' %}" class="block px-4 py-2 text-gray-700 hover:bg-primary/10 hover:text-primary">Location Map</a>
                                <a href="{% url 'mental_health_heatmap' %}" class="block px-4 py-2 text-gray-700 hover:bg-primary/10 hover:text-primary">Heatmap</a>
                                {% comment %} <a href="{% url 'recovery_stories' %}" class="block px-4 py-2 text-gray-700 hover:bg-primary/10 hover:text-primary">Recovery Stories</a> {% endcomment %}
                                <a href="{% url 'logout' %}" class="block px-4 py-2 text-gray-700 hover:bg-red-50 hover:text-red-600">Logout</a>
                            </div>
                        </div>
                    {% else %}
                        <a href="{% url 'forum_list' %}" class="text-white/90 hover:text-white font-medium transition">Support Forum</a>
                        <a href="{% url 'resources' %}" class="text-white/90 hover:text-white font-medium transition">Helplines</a>
                        <a href="{% url 'login' %}" class="text-white/90 hover:text-white font-medium transition cursor-pointer">Login</a>
                        <a href="{% url 'doctor_login' %}" class="text-white/90 hover:text-white font-medium transition cursor-pointer">Doctor Login</a>
                        <a href="{% url 'register' %}" class="bg-[#95d5b2] text-[#1b4332] px-4 py-2 rounded-lg font-medium hover:opacity-90 transition cursor-pointer">Sign Up</a>
                    {% endif %}
                </div>
            </div>
        </div>
        <div class="hidden md:hidden border-t border-white/20" id="mobileMenu">
            <div class="px-4 py-3 flex flex-col gap-2">
                <a href="{% url 'home' %}" class="text-white/90 hover:text-white py-2">Home</a>
                <a href="{% url 'chat' %}" class="text-white/90 hover:text-white py-2">AI Chat</a>
                <a href="{% url 'assessments' %}" class="text-white/90 hover:text-white py-2">Assessments</a>
                <a href="{% url 'counsellor_booking' %}" class="text-white/90 hover:text-white py-2">Book Counsellor</a>
                <a href="{% url 'mood_tracker' %}" class="text-white/90 hover:text-white py-2">Mood</a>
                <a href="{% url 'contact_us' %}" class="text-white/90 hover:text-white py-2">Contact us</a>
                {% if user.is_authenticated %}
                    <p class="text-white/70 text-xs uppercase pt-2">Dashboard menu</p>
                    <a href="{% url 'dashboard' %}" class="text-white/90 hover:text-white py-2">Dashboard</a>
                    <a href="{% url 'doctor_dashboard' %}" class="text-white/90 hover:text-white py-2">Doctor Panel</a>
                    <a href="{% url 'resources' %}" class="text-white/90 hover:text-white py-2">Helplines</a>
                    <a href="{% url 'forum_list' %}" class="text-white/90 hover:text-white py-2">Support Forum</a>
                    <a href="{% url 'location_map' %}" class="text-white/90 hover:text-white py-2">Location Map</a>
                    <a href="{% url 'mental_health_heatmap' %}" class="text-white/90 hover:text-white py-2">Heatmap</a>
                    <a href="{% url 'recovery_stories' %}" class="text-white/90 hover:text-white py-2">Recovery Stories</a>
                    <a href="{% url 'logout' %}" class="text-white/90 hover:text-white py-2">Logout</a>
                {% else %}
                    <a href="{% url 'forum_list' %}" class="text-white/90 hover:text-white py-2">Support Forum</a>
                    <a href="{% url 'resources' %}" class="text-white/90 hover:text-white py-2">Helplines</a>
                    <a href="{% url 'login' %}" class="text-white/90 hover:text-white py-2 cursor-pointer">Login</a>
                    <a href="{% url 'doctor_login' %}" class="text-white/90 hover:text-white py-2 cursor-pointer">Doctor Login</a>
                    <a href="{% url 'register' %}" class="bg-[#95d5b2] text-[#1b4332] px-4 py-2 rounded-lg font-medium text-center cursor-pointer">Sign Up</a>
                {% endif %}
            </div>
        </div>
    </nav>

    <main class="flex-1 pb-8">
        <div class="w-full px-4 sm:px-6 lg:px-8 mt-4 mb-2">
            <a href="#" onclick="history.back(); return false;" class="inline-flex items-center gap-1 text-[#2d6a4f] hover:text-[#1b4332] font-medium transition" aria-label="Go back">
                <svg class="w-5 h-5" fill="none" stroke="currentColor" viewBox="0 0 24 24"><path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M10 19l-7-7m0 0l7-7m-7 7h18"/></svg>
                
            </a>
        </div>
        {% if messages %}
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 mt-4">
            {% for message in messages %}
            <div class="rounded-lg p-4 mb-2 flex items-center justify-between {% if message.tags == 'error' %}bg-red-50 text-red-800 border border-red-200{% elif message.tags == 'success' %}bg-green-50 text-green-800 border border-green-200{% else %}bg-blue-50 text-blue-800 border border-blue-200{% endif %}">
                <span>{{ message }}</span>
                <button type="button" class="text-lg hover:opacity-70" onclick="this.parentElement.remove()">×</button>
            </div>
            {% endfor %}
        </div>
        {% endif %}
        {% block content %}{% endblock %}
    </main>

    <footer class="bg-primary-dark text-white/90 mt-auto">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 text-center">
            <p>MindMend — Stigma-free mental health support. In crisis? Call <strong>KIRAN 1800-599-0019</strong> or <strong>Tele-MANAS 14416</strong> (24/7)</p>
        </div>
    </footer>

    <script>
        var navToggle = document.getElementById('navToggle');
        if (navToggle) navToggle.addEventListener('click', function() {
            var menu = document.getElementById('mobileMenu');
            if (menu) menu.classList.toggle('hidden');
        });
        var dropdownBtn = document.getElementById('dashboardDropdownBtn');
        if (dropdownBtn) dropdownBtn.addEventListener('click', function(e) {
            e.stopPropagation();
            const menu = document.getElementById('dashboardDropdownMenu');
            if (menu) {
                menu.classList.toggle('opacity-0');
                menu.classList.toggle('invisible');
                menu.classList.toggle('opacity-100');
                menu.classList.toggle('visible');
            }
        });
        document.addEventListener('click', () => {
            const menu = document.getElementById('dashboardDropdownMenu');
            if (menu && menu.classList.contains('visible')) {
                menu.classList.add('opacity-0', 'invisible');
                menu.classList.remove('opacity-100', 'visible');
            }
        });

    </script>
    <script>
        (function () {
            if (!navigator.geolocation) return;

            const LAST_KEY = 'mindmend_geo_last_sent_at';
            const HOURS_BETWEEN_UPDATES = 6;

            function shouldSendNow() {
                const last = parseInt(localStorage.getItem(LAST_KEY) || '0', 10);
                if (!last) return true;
                return (Date.now() - last) > (HOURS_BETWEEN_UPDATES * 60 * 60 * 1000);
            }

            function sendCoords() {
                if (!shouldSendNow()) return;
                navigator.geolocation.getCurrentPosition(function (pos) {
                    fetch('{% url "share_location_api" %}', {
                        method: 'POST',
                        headers: { 'Content-Type': 'application/json' },
                        body: JSON.stringify({
                            lat: pos.coords.latitude,
                            lon: pos.coords.longitude
                        })
                    }).then(function () {
                        localStorage.setItem(LAST_KEY, String(Date.now()));
                    }).catch(function () {});
                }, function () {}, { enableHighAccuracy: true, timeout: 10000, maximumAge: 300000 });
            }

            // Only auto-send when permission is already granted (no extra prompt).
            if (navigator.permissions && navigator.permissions.query) {
                navigator.permissions.query({ name: 'geolocation' }).then(function (res) {
                    if (res.state === 'granted') sendCoords();
                }).catch(function () {});
            }
        })();
    </script>
    {% block scripts %}{% endblock %}
</body>
</html>
